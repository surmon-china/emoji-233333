/**
 * @file emoji-233333 v0.3.2
 * @copyright Copyright (c) Surmon. All rights reserved.
 * @license Released under the MIT License.
 * @author Surmon <https://github.com/surmon-china>
 */
var t=Object.freeze({cache:!0,base:"emoji",scale:.5,speed:10,density:3,staggered:!0,increaseSpeed:.08,emoji:null}),e=function(e){this.emojis=[],this.kichikuing=!1,this.repeater=null,this.emojiImg=null,this.options=Object.assign({},t,e),this._speed=this.options.speed,this.initialize()},i={windowSize:{configurable:!0}};e.prototype.preLoadImage=function(t){return new Promise((function(e,i){var a=new Image;a.src=t,a.complete?e(a):(a.onload=function(){e(a)},a.onerror=function(){i(a)})}))},e.prototype.initialize=function(){var t=this.options;this.canvas="string"==typeof t.base?document.getElementById(t.base):t.base,this.canvas.width=this.canvas.width||this.windowSize.width,this.canvas.height=this.canvas.height||this.windowSize.height,this.context=this.canvas.getContext("2d");var i=window.devicePixelRatio||t.ratio||1,a=e.getPixelRatio(this.context),s=this.options.ratio||i/a;this.options.ratio=s,this.canvas.style.width=this.canvas.width+"px",this.canvas.style.height=this.canvas.height+"px",this.canvas.width*=s,this.canvas.height*=s,t.cache&&this.createCacheCanvas(),this.createEmojis()},e.prototype.createEmojis=function(){var t=this,i=this.options,a=this.emojis;return i.emoji?this.preLoadImage(i.emoji).then((function(s){t.emojiImg=s;for(var n=parseInt(t.canvas.style.width),h=parseInt(n/(s.width*i.scale))*i.density,o=0;o<h;o++){var c=n/h*o*i.ratio,r=-e.rand(t.canvas.height);i.staggered&&(c=c*Math.random()*2);var d=e.rand(6)/10;d=d<.5?.8:d;var p={x:~~(.5+c),y:~~(.5+r),w:~~(.5+s.width*d),h:~~(.5+s.height*d),scale:i.scale};if(i.staggered){var g=0,m=t.canvas.width,l=m/3,v=2*l;if(c<l)g=c+1.2*m*Math.random();else if(c>v)g=c-1.2*v*Math.random();else{var u=Math.random();g=u<.5?l*u:m*Math.random()}p.targetX=~~(.5+g)}a.push(p)}})):Promise.reject(new Error("未得到有效的 emoji 地址，无法继续！"))},e.prototype.drawStep=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);var t=!1,e=this.canvas.height;this._speed+=this.options.increaseSpeed,this.cacheCanvasContext.clearRect(0,0,this.canvas.width,this.canvas.height);for(var i=0;i<this.emojis.length;i++){var a=this.emojis[i],s=.6*this._speed;a.y<e?(this.options.staggered&&(a.x<a.targetX?a.targetX-a.x<s?a.x=a.targetX:a.x+=s:a.x-a.targetX<s?a.x=a.targetX:a.x-=s),a.y+=this._speed,this.options.cache?this.cacheCanvasContext.drawImage(this.emojiImg,~~(.5+a.x),~~(.5+a.y),~~(.5+a.w*a.scale),~~(.5+a.h*a.scale)):this.context.drawImage(this.emojiImg,~~(.5+a.x),~~(.5+a.y),~~(.5+a.w*a.scale),~~(.5+a.h*a.scale)),t=!0):(this.emojis[i]=null,this.emojis.splice(i,1))}t?this.options.cache&&this.context.drawImage(this.cacheCanvas,0,0,this.canvas.width,this.canvas.height):(this.kichikuing=!1,window.cancelAnimationFrame(this.repeater),this.options.onEnded&&this.options.onEnded())},e.prototype.createCacheCanvas=function(){this.cacheCanvas=document.createElement("canvas"),this.cacheCanvas.width=this.canvas.width,this.cacheCanvas.height=this.canvas.height,this.cacheCanvasContext=this.cacheCanvas.getContext("2d")},e.prototype._launch=function(){this.kichikuing=!0,this.repeater=window.requestAnimationFrame(this._launch.bind(this)),this.drawStep()},e.prototype.launch=function(){var t=this;if(this.kichikuing)return!1;this.createEmojis().then((function(){t.options.onStart&&t.options.onStart(),t._speed=t.options.speed,t._launch()}))},e.prototype.update=function(t){t&&(this.options=Object.assign({},this.options,t))},i.windowSize.get=function(){return{width:document.documentElement.clientWidth||document.body.clientWidth,height:document.documentElement.clientHeight||document.body.clientHeight}},e.getPixelRatio=function(t){return t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1},e.rand=function(t){return Math.floor(Math.random()*t+1)},Object.defineProperties(e.prototype,i);export default e;
